import time
import json
import random
import paho.mqtt.client as mqtt
from datetime import datetime

BROKER = "mosquitto"   # IP do seu broker Mosquitto
PORT = 1883
TOPIC = "iot/traffic/ops243a"

def generate_payload():
    return {
        "device_id": "ops243a_01",
        "timestamp": datetime.utcnow().isoformat(),
        "speed_mps": round(random.uniform(0, 30), 2),  # 0 a 30 m/s (~108 km/h)
        "direction": random.choice(["approaching", "departing"]),
        "signal_strength": random.randint(-80, -40)   # dBm
    }

client = mqtt.Client(client_id="ops243a_emulator")
client.connect(BROKER, PORT, 60)

try:
    while True:
        payload = generate_payload()
        client.publish(TOPIC, json.dumps(payload))
        print("Publicado:", payload)
        time.sleep(1)  # 1 Hz de taxa de envio
except KeyboardInterrupt:
    client.disconnect()
